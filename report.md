<h2 align = "center"> <b>ASSIGNMENT 2 : CS432 </b></h2>
<h1 align = "center">REPORT</h1>
<h4 align = "center"> Sachin Yadav 18110148 </h4>

# Directory Structure
```bash
./
├── 01.sql      #the query files for each question numbered from 01 to 21
├── 02.sql
├── 03.sql
├── 04.sql
├── 05.sql
├── 06.sql
├── 07.sql
├── 08.sql
├── 09.sql
├── 10.sql
├── 11.sql
├── 12.sql
├── 13.sql
├── 14.sql
├── 15.sql
├── 16.sql
├── 17.sql
├── 18.sql
├── 19.sql
├── 20.sql
├── 21.sql
├── database_schema.pdf # the Database Schema as generated by Jetbrains DataGrip toop
├── filled-dbdump.sql   #Database Instance with tables filled with dummy records
├── images  #images of the output of queries and database schema
├── initial-dbdump.sql  #Database Instance with empty tables
├── report.md       # the report in MD format, same was converted to PDF form report.pdf
├── report.pdf      # the PDF of the report
└── schema.sql     #contains the definition of the tables in the database
```

# Instructions
- Run ```source schema.sql``` to initialize a database named 'x' and tables inside it of users, products, etc.
- Run ``source 01.sql``` to fill the tables with dummy records.


# Database Schema
![Database Schema](./images/database_schema.png)

[Generated using JetBrains DataGrip]
- The attributes with blue table sign in front of their name are UNIQUE.
- The Blue Key represents FOREIGN KEY and Gold Key as PRIMARY KEY.

**For more detailed Database Schema refer to ```schema.sql``` file**

## Question 1.
**Refer to file ```01.sql```**

## Question 2.
Here I deleted a user with email 'niraj@gmail.com'.
I have set  ```ON DELETE CASCADE``` for majority of Foreign Keys.
In reviews relation, the user_id Foreign Key is allowed to be NULL.

```sql
UPDATE reviews
SET user_id = NULL, username = 'Anonymous'
WHERE user_id = (SELECT user_id
    FROM users
    WHERE email = 'niraj@gmail.com');

DELETE FROM users
WHERE email = 'niraj@gmail.com';
```

![02-result](./images/02.png)


## Question 3.
```sql
UPDATE products
SET price = price * 1.10
where price < 5000 AND pdt_id IN (
    SELECT pdt_id 
    FROM user_views
    WHERE created_at >= DATE_SUB(CURDATE(),INTERVAL 3 MONTH)
    GROUP BY pdt_id
    HAVING COUNT(DISTINCT user_id) > 10
);
```
![](images/03.png)

Here the prices of 5. Inferno, 6. Lolita, 9. David Copperfield, 14. Neomi Watch R2 and 24. Leeves Men Jeans have changed.


## Question 4.
```sql
INSERT INTO addresses (user_id, street, city, province, pincode) VALUES 
(1, 'House 52, Mahavir Road, Rohini', 'Delhi', 'Delhi', 110074),
(1, 'Google Office, Nixty Road, Pixis Industrial Complex', 'Bangalore', 'Karnataka', 389252),
(1, 'Room 239, Hostel Chimair, IIT Gandhinagar', 'Gandhinagar', 'Gujarat', 291045);
```

![](images/04.png)


## Question 5.
```sql
SELECT DISTINCT phone, email 
FROM users
where city = 'Madrid' AND user_id IN (
    SELECT user_id 
    FROM orders
    GROUP BY user_id
    HAVING SUM(price) >= 10000
);
```

![](images/05.png)


## Question 6.
```sql
SELECT name, pdt_id, user_id
FROM (
    SELECT name, pdt_id
    FROM products 
    WHERE name LIKE '%mi%'
)P LEFT OUTER JOIN (
    SELECT DISTINCT user_id, pdt_id
    FROM order_items
)O USING (pdt_id);
```

![](images/06.png)


## Question 7.
```sql
SELECT retailer_id, email
FROM retailers 
WHERE city = 'Ahmedabad';
```

![](images/07.png)


## Question 8.
```sql
SELECT * 
FROM orders 
WHERE user_id = (
    SELECT user_id
    FROM users
    ORDER BY created_at DESC
    LIMIT 1)
ORDER BY created_at DESC
LIMIT 3;
```

![](images/08.png)

## Question 9.
```sql
SELECT F.user_id, name, pdt_id, category, price
FROM products INNER JOIN (
    SELECT cart_items.user_id, pdt_id
    FROM cart_items INNER JOIN (
        SELECT user_id
        FROM users
        ORDER BY created_at ASC
        LIMIT 2
    ) U USING(user_id)
)F USING (pdt_id);   
```

![](images/09.png)


## Question 10.
**Assumption**: By 'after 2010', we mean book published in 2011 (excluding 2010) and coming years.
```sql
SELECT *
FROM novels
WHERE publication_date >= '2011-01-01';
```

![](images/10.png)

## Question 11.
```sql
SELECT pdt_id, e.electronic_id, p.name, price, brand, model, description, date_of_manufacture
FROM electronics e JOIN products p USING(pdt_id)
WHERE price BETWEEN 10000 AND 20000;
```

![](images/11.png)

## Question 12.
```sql
SELECT user_id, username, email
FROM    
    (SELECT user_id
    FROM order_items INNER JOIN products USING (pdt_id)
    WHERE category = "electronics"
    GROUP BY user_id
    HAVING SUM(quantity) > 3) A
INNER JOIN
    (SELECT user_id
    FROM order_items INNER JOIN products USING (pdt_id)
    WHERE category = "novels"
    GROUP BY user_id
    HAVING SUM(quantity) > 3) B
USING (user_id) JOIN users USING (user_id);
```

![](images/12.png)

## Question 13.
```sql
SELECT pdt_id, electronic_id, name, electronics.category, electronics.brand, electronics.model, price
FROM electronics JOIN products USING (pdt_id)
WHERE electronics.pdt_id = products.pdt_id AND electronics.category = "Laptop"
ORDER BY price ASC;
```

![](images/13.png)

## Question 14.
```sql
SELECT *
FROM products 
WHERE created_at >= '2011-11-12 00:00:00';
```

![](images/14.png)


## Question 15.

```sql
SELECT name, novels.*, price
FROM novels JOIN products using (pdt_id)
WHERE author = "Dan Brown";
```

![](images/15.png)

## Question 16.
```sql
SELECT DISTINCT user_id, username, email, phone
FROM users
WHERE user_id in (
    SELECT user_id
    FROM cart_items
    WHERE quantity < 5
);
```

![](images/16.png)


## Question 17.
```sql
SELECT *
FROM orders 
WHERE order_id = (
    SELECT order_id
    FROM order_items
    GROUP BY order_id
    ORDER BY SUM(quantity) DESC
    LIMIT 1);
```

![](images/17.png)

## Question 18.
```sql
SELECT * 
FROM products 
WHERE created_at >= DATE_SUB(CURDATE(),INTERVAL 10 DAY);
```

![](images/18.png)

## Question 19.
```sql
SELECT DISTINCT retailer_id
FROM products 
WHERE pdt_id in (
    SELECT pdt_id 
    FROM order_items
    WHERE user_id = 1
);
```

![](images/19.png)

## Question 20.
**Assumption:**: The prices in the original products tables will remain same. Only the prices in holi_Deals change.
```sql
CREATE TABLE holi_Deals
SELECT *
FROM products
WHERE created_at >= DATE_SUB(CURDATE(),INTERVAL 100 DAY);

UPDATE holi_Deals
SET price = price * 0.85;
```

![](images/20.png)

## Question 21.
**About the recommendation algorithm**
- Prepare a list of all the products that matches with the past searches of the user. [Descending Order of the time of search]
- Remove all the items for the above list, which the user has already bought after searching.
- Here, I thought that a user have searched for a product and bought one. So I need not recommend the same product that he/she bought again, instead I show the other products to which his/her searchces matches.

```sql
SELECT pdt_id, name, price
FROM (
    SELECT user_id, searches.created_at, pdt_id
    FROM searches, products
    WHERE name LIKE CONCAT('%', body, '%')
) T INNER JOIN products USING(pdt_id)
WHERE T.user_id = 1 AND pdt_id NOT IN (
    SELECT pdt_id
    FROM order_items
    WHERE user_id = 1
)
GROUP BY pdt_id
ORDER BY MAX(T.created_at) DESC
LIMIT 10;
```

![](images/21.png)

**Explanation: (Dates given in Descending -- User 1)**
- Searched "iPad" on 26 Nov 2020.
- Searched "Apple" on 20 Nov 2020.
- Ordered "Lolita" on 10 Nov 2020.
- Searched "Lolita" on 1 November 2020.
- Searched "watch" on 20 Oct 2020.
- Searched "Xiaomi" on 15 Oct 2020.
- Ordered "Dell Inspiron D3" on 15 Oct 2020.
- Searched "Dell" on 20 Sept 2020.
- Searched "Xiaomi" on 12 Aug 2020.
- Ordered "Inferno" on 07 Jan 2010.
- Searched for "Inferno" on 06 Jan 2010.
- Searched for "Vinci Code" on 06 Jan 2010.